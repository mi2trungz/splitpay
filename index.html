<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quiz luy·ªán c√¢u sai (d√°n ƒë·ªÅ + ƒë√°p √°n)</title>
  <style>
    :root { color-scheme: dark light; }

    body {
      font-family: Arial, sans-serif;
      background: #020617;
      padding: 20px;
      color: #e5e7eb;
      font-size: 16px;
      line-height: 1.4;
    }

    /* ====== SCALE (k√≠ch c·ª° trang) ====== */
    body.scale-small  { font-size: 14px; }
    body.scale-medium { font-size: 16px; }
    body.scale-large  { font-size: 20px; }

    .box {
      background: #020617;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.8);
      border: 1px solid #1f2937;
      max-width: 1100px;
      margin: 0 auto 20px auto;
    }
    h2 { margin-top: 0; color: #e5e7eb; }
    p { color: #9ca3af; }

    textarea, input, select {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #374151;
      font-family: inherit;
      background: #020617;
      color: #e5e7eb;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(15,23,42,0.6);
      font-size: 0.95em;
    }
    textarea:focus, input:focus, select:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 1px #6366f1;
    }
    textarea { min-height: 180px; resize: vertical; }

    button {
      padding: 10px 18px;
      border: none;
      border-radius: 999px;
      background: #6366f1;
      color: white;
      cursor: pointer;
      font-weight: bold;
      margin-right: 8px;
      box-shadow: 0 8px 20px rgba(99,102,241,0.4);
      transition: transform 0.08s, box-shadow 0.08s, opacity 0.15s;
      font-size: 0.9em;
    }
    button:hover {
      opacity: 0.95;
      box-shadow: 0 10px 26px rgba(99,102,241,0.5);
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 6px 18px rgba(99,102,241,0.4);
    }
    .secondary-btn {
      background: #111827;
      color: #e5e7eb;
      box-shadow: 0 4px 12px rgba(15,23,42,0.7);
    }
    .danger-btn {
      background: #b91c1c;
      box-shadow: 0 4px 12px rgba(185,28,28,0.6);
    }

    /* N√∫t Tr·∫£ l·ªùi d√†i h∆°n */
    #submitBtn {
      padding: 10px 36px;
      min-width: 150px;
    }

    /* N√∫t Ti·∫øp t·ª•c ‚Äì m√†u v√†ng */
    #nextBtn {
      background: #eab308;
      color: #111827;
      box-shadow: 0 8px 20px rgba(234,179,8,0.5);
      padding: 10px 36px;
      min-width: 150px;
    }
    #nextBtn:hover {
      box-shadow: 0 10px 26px rgba(234,179,8,0.7);
    }

    .inline-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .inline-row > * { flex: 1; min-width: 120px; }
    .inline-row button { flex: 0 0 auto; margin: 0; }

    .question-card {
      padding: 20px;
      background: #020617;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.9);
      border: 1px solid #1f2937;
      max-width: 1100px;
      margin: 10px auto 0 auto;
    }

    #progress { margin-bottom: 8px; font-size: 0.85em; color: #9ca3af; }
    #quiz-title {
      font-size: 1.15em;
      margin-bottom: 6px;
      white-space: pre-wrap;
    }
    #quiz-text {
      color: #d1d5db;
      margin-bottom: 8px;
      white-space: pre-wrap;
    }

    /* ·∫£nh c·ªßa c√¢u h·ªèi */
    #quiz-image-wrapper { margin-bottom: 12px; }
    #quiz-image {
      max-width: 100%;
      border-radius: 10px;
      border: 1px solid #1f2937;
      display: block;
      cursor: zoom-in;
      transition: box-shadow 0.12s, transform 0.08s;
    }
    #quiz-image:hover {
      box-shadow: 0 0 0 2px rgba(99,102,241,0.7);
      transform: translateY(-1px);
    }

    /* modal ph√≥ng to ·∫£nh */
    #image-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      cursor: zoom-out;
    }
    #image-modal {
      max-width: 92vw;
      max-height: 92vh;
      border-radius: 12px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.9);
    }

    /* Block answer style */
    .choice-row { margin-bottom: 10px; }
    .choice-card {
      width: 100%;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      cursor: pointer;
      transition: border-color 0.12s, background 0.12s,
                  box-shadow 0.12s, transform 0.05s;
      text-align: left;
    }
    .choice-card:hover {
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79,70,229,0.5);
    }
    .choice-card.selected {
      border-color: #6366f1;
      background: #111827;
      box-shadow: 0 0 0 1px rgba(99,102,241,0.8);
      transform: translateY(-1px);
    }
    .choice-prefix {
      font-weight: 600;
      color: #9ca3af;
      flex-shrink: 0;
      min-width: 20px;
    }
    .choice-text {
      color: #e5e7eb;
      white-space: pre-wrap;
    }

    /* t√¥ m√†u sau khi tr·∫£ l·ªùi */
    .choice-card.correct {
      border-color: #22c55e;
      background: #052e16;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.9);
    }
    .choice-card.incorrect {
      border-color: #ef4444;
      background: #450a0a;
      box-shadow: 0 0 0 1px rgba(248,113,113,0.9);
    }

    #status { margin-top: 12px; font-weight: bold; }
    #status.ok { color: #4ade80; }
    #status.err { color: #fb7185; }

    .small-hint {
      font-size: 0.75em;
      color: #9ca3af;
      margin-top: -6px;
      margin-bottom: 10px;
    }

    /* ===== H√†ng n√∫t trong khi l√†m b√†i ===== */
    .button-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .button-group-left,
    .button-group-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* ===== Ch·∫ø ƒë·ªô giao di·ªán ƒëi·ªán tho·∫°i ===== */
    body.mobile-mode {
      font-size: 19px;
      line-height: 1.5;
      padding: 10px 6px;
    }
    body.mobile-mode .box,
    body.mobile-mode .question-card {
      max-width: 100%;
      margin: 0 0 16px 0;
      border-radius: 0;
      box-shadow: none;
      border-left: none;
      border-right: none;
    }
    body.mobile-mode h2 {
      font-size: 22px;
    }
    body.mobile-mode textarea,
    body.mobile-mode input,
    body.mobile-mode select {
      font-size: 18px;
      padding: 10px 10px;
    }
    body.mobile-mode button {
      font-size: 17px;
      padding: 12px 18px;
    }
    body.mobile-mode #submitBtn,
    body.mobile-mode #nextBtn {
      padding: 12px 40px;
    }
    body.mobile-mode #quiz-title {
      font-size: 21px;
    }
    body.mobile-mode #progress {
      font-size: 15px;
    }
    body.mobile-mode .choice-card {
      padding: 16px 18px;
    }
    body.mobile-mode .choice-text {
      font-size: 18px;
    }
    body.mobile-mode .choice-prefix {
      font-size: 18px;
    }

    /* ====== GIAO DI·ªÜN S√ÅNG ====== */
    body.light-theme {
      background: #f3f4f6;
      color: #111827;
    }
    body.light-theme .box,
    body.light-theme .question-card {
      background: #ffffff;
      border-color: #d1d5db;
      box-shadow: 0 10px 30px rgba(15,23,42,0.12);
    }
    body.light-theme h2 { color: #111827; }
    body.light-theme p,
    body.light-theme .small-hint,
    body.light-theme #progress {
      color: #4b5563;
    }
    body.light-theme textarea,
    body.light-theme input,
    body.light-theme select {
      background: #f9fafb;
      color: #111827;
      border-color: #d1d5db;
      box-shadow: inset 0 0 0 1px rgba(209,213,219,0.6);
    }
    body.light-theme textarea:focus,
    body.light-theme input:focus,
    body.light-theme select:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 1px #6366f1;
    }

    body.light-theme .secondary-btn {
      background: #e5e7eb;
      color: #111827;
      box-shadow: 0 4px 12px rgba(148,163,184,0.7);
    }

    body.light-theme .choice-card {
      background: #ffffff;
      border-color: #e5e7eb;
    }
    body.light-theme .choice-card:hover {
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(79,70,229,0.25);
    }
    body.light-theme .choice-card.selected {
      background: #eef2ff;
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79,70,229,0.5);
    }
    body.light-theme .choice-text { color: #111827; }
    body.light-theme .choice-prefix { color: #6b7280; }

    body.light-theme #quiz-image {
      border-color: #e5e7eb;
    }

    /* ===== Popup ch·ªçn nhi·ªÅu ƒë·ªÅ ===== */
    #multiSetModalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }
    #multiSetModal {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #1f2937;
      box-shadow: 0 20px 40px rgba(0,0,0,0.9);
      max-width: 420px;
      width: 90%;
      padding: 18px 18px 14px;
      color: #e5e7eb;
    }
    #multiSetModal h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 18px;
    }
    #multiSetList {
      max-height: 260px;
      overflow-y: auto;
      margin: 10px 0 12px;
      padding-right: 4px;
    }
    .multi-set-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 14px;
    }
    .multi-set-item label {
      cursor: pointer;
      flex: 1;
    }
    body.light-theme #multiSetModal {
      background: #ffffff;
      border-color: #d1d5db;
      color: #111827;
      box-shadow: 0 20px 40px rgba(15,23,42,0.25);
    }
  </style>
</head>
<body>

<div class="box">
  <h2>B∆∞·ªõc 1: D√°n ƒë·ªÅ</h2>

  <textarea id="rawQuestions" placeholder="D√°n t·∫•t c·∫£ c√¢u h·ªèi v√†o ƒë√¢y..."></textarea>

  <h2>B∆∞·ªõc 2: Nh·∫≠p ƒë√°p √°n ƒë√∫ng</h2>
  <p>
    V√≠ d·ª•: n·∫øu c√≥ 3 c√¢u v√† ƒë√°p √°n l·∫ßn l∆∞·ª£t l√† A, B, D ‚Üí nh·∫≠p <strong>ABD</strong>.<br>
    K√Ω t·ª± th·ª© 1 ·ª©ng v·ªõi c√¢u h·ªèi <strong>ƒë·∫ßu ti√™n</strong> trong √¥ tr√™n (b·∫•t k·ªÉ s·ªë 14, 15...).
  </p>
  <input id="answerKey" placeholder="V√≠ d·ª•: ABDCDAB..." />

  <h2>B∆∞·ªõc 3: ƒê·∫∑t t√™n & l∆∞u b·ªô ƒë·ªÅ</h2>
  <div class="small-hint">
    V√≠ d·ª•: <em>‚ÄúCh∆∞∆°ng 3 - IFE‚Äù</em>, <em>‚Äúƒê·ªÅ c≈© 2024 - IRP/PPP‚Äù</em>...
  </div>
  <div class="inline-row" style="margin-bottom: 12px;">
    <input id="setName" placeholder="T√™n b·ªô ƒë·ªÅ..." />
    <button onclick="saveCurrentSet()">L∆∞u b·ªô ƒë·ªÅ</button>
  </div>

  <h2>B·ªô ƒë·ªÅ ƒë√£ l∆∞u</h2>
  <div class="inline-row">
    <select id="savedSetsSelect"></select>
    <button onclick="loadSelectedSet()">T·∫£i b·ªô ƒë·ªÅ</button>
    <button class="danger-btn" onclick="deleteSelectedSet()">Xo√° b·ªô ƒë·ªÅ</button>
  </div>
  <div class="inline-row" style="margin-top:8px;">
    <button class="secondary-btn" onclick="exportSets()">Xu·∫•t t·∫•t c·∫£ b·ªô ƒë·ªÅ (.json)</button>
    <button onclick="triggerImportSets()">T·∫£i b·ªô ƒë·ªÅ t·ª´ file</button>
  </div>
  <input type="file" id="setsFileInput" accept="application/json" style="display:none" onchange="importSetsFromFile(event)" />
  <div class="small-hint">
    B·ªô ƒë·ªÅ ƒë∆∞·ª£c l∆∞u trong LocalStorage. B·∫°n c√≥ th·ªÉ xu·∫•t ra file JSON ƒë·ªÉ backup, r·ªìi t·∫£i l√™n l·∫°i khi ƒë·ªïi m√°y ho·∫∑c tr√¨nh duy·ªát.
  </div>

  <hr style="border-color:#1f2937;margin:18px 0;" />

  <button onclick="createQuiz()">T·∫°o ƒë·ªÅ &amp; b·∫Øt ƒë·∫ßu l√†m b√†i</button>
  <button class="secondary-btn" onclick="openMultiSetModal()">T·∫°o ƒë·ªÅ t·ª´ nhi·ªÅu ƒë·ªÅ ƒë√£ l∆∞u</button>

  <div style="margin-top:14px;" class="inline-row">
    <button class="secondary-btn" onclick="toggleMobileMode()">
      Giao di·ªán ƒëi·ªán tho·∫°i: <span id="mobileModeLabel">T·∫Øt</span>
    </button>
    <button class="secondary-btn" onclick="toggleTheme()">
      Giao di·ªán: <span id="themeLabel">T·ªëi</span>
    </button>
    <div style="flex:1;min-width:140px;">
      <label for="scaleSelect" class="small-hint" style="margin-bottom:4px;display:block;">K√≠ch c·ª° hi·ªÉn th·ªã:</label>
      <select id="scaleSelect" onchange="changeScale()">
        <option value="small">Nh·ªè</option>
        <option value="medium" selected>V·ª´a</option>
        <option value="large">L·ªõn</option>
      </select>
    </div>
  </div>
</div>

<div class="question-card" id="quiz-box" style="display:none;">
  <div id="progress"></div>
  <h2 id="quiz-title">C√¢u h·ªèi</h2>
  <div id="quiz-text"></div>

  <div id="quiz-image-wrapper" style="display:none;">
    <img id="quiz-image" alt="H√¨nh minh ho·∫° c√¢u h·ªèi" />
  </div>

  <div class="choice-row">
    <div class="choice-card" data-index="0">
      <span class="choice-prefix">A.</span>
      <span class="choice-text" id="c1"></span>
    </div>
  </div>
  <div class="choice-row">
    <div class="choice-card" data-index="1">
      <span class="choice-prefix">B.</span>
      <span class="choice-text" id="c2"></span>
    </div>
  </div>
  <div class="choice-row">
    <div class="choice-card" data-index="2">
      <span class="choice-prefix">C.</span>
      <span class="choice-text" id="c3"></span>
    </div>
  </div>
  <div class="choice-row">
    <div class="choice-card" data-index="3">
      <span class="choice-prefix">D.</span>
      <span class="choice-text" id="c4"></span>
    </div>
  </div>

  <!-- H√†ng n√∫t: tr√°i = Tr·∫£ l·ªùi / Ti·∫øp t·ª•c, ph·∫£i = B·ªè qua / Ch·ªãu / Reset -->
  <div class="button-row">
    <div class="button-group-left">
      <button id="submitBtn" onclick="submitAnswer()">Tr·∫£ l·ªùi</button>
      <button id="nextBtn" class="secondary-btn" style="display:none;" onclick="manualNext()">Ti·∫øp t·ª•c</button>
    </div>
    <div class="button-group-right">
      <button id="skipBtn" class="secondary-btn" onclick="skipQuestion()">B·ªè qua</button>
      <button id="giveUpBtn" class="secondary-btn" onclick="giveUpQuestion()">Ch·ªãu</button>
      <button id="resetBtn" class="secondary-btn" onclick="confirmReset()">Reset</button>
    </div>
  </div>

  <div id="status"></div>
</div>

<!-- overlay ph√≥ng to ·∫£nh -->
<div id="image-modal-overlay">
  <img id="image-modal" alt="Zoom image" />
</div>

<!-- Popup ch·ªçn nhi·ªÅu ƒë·ªÅ -->
<div id="multiSetModalOverlay">
  <div id="multiSetModal">
    <h3>Ch·ªçn nhi·ªÅu ƒë·ªÅ ƒë·ªÉ g·ªôp</h3>
    <div id="multiSetList"></div>
    <div class="small-hint">Ch·ªçn 1 ho·∫∑c nhi·ªÅu ƒë·ªÅ b√™n tr√™n, sau ƒë√≥ b·∫•m "T·∫°o ƒë·ªÅ t·ªïng h·ª£p".</div>
    <div style="text-align:right;margin-top:10px;">
      <button class="secondary-btn" onclick="closeMultiSetModal()">ƒê√≥ng</button>
      <button onclick="createCombinedQuizFromSelected()">T·∫°o ƒë·ªÅ t·ªïng h·ª£p</button>
    </div>
  </div>
</div>

<script>
let questions = [];   // { text, choices[4], correctIndex, image? }
let roundList = [];
let wrongList = [];
let current = 0;
let round = 1;
let finished = false;
let selectedChoice = null;
let shuffleEnabled = false;
let waitingToContinue = false; // ch·ªù b·∫•m "Ti·∫øp t·ª•c" sau khi tr·∫£ l·ªùi sai / b·ªè qua / ch·ªãu

const LS_KEY_SETS   = "quizSets_v1";
const LS_KEY_STATE  = "quizCurrentState_v1";
const LS_KEY_SCALE  = "quizScale";
const LS_KEY_THEME  = "quizTheme";
const LS_KEY_MOBILE = "quizMobileMode";

/* ---------- ti·ªán √≠ch ---------- */
function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* chuy·ªÉn m·ªçi chu·ªói c√≥ ‚â•3 space li√™n ti·∫øp th√†nh ___ */
function normalizeSpaces(txt) {
  return txt.replace(/ {3,}/g, "___");
}

/* xo√° prefix "C√¢u xx:" trong text (n·∫øu c√≥) */
function stripCauPrefix(text) {
  const m = text.match(/^C√¢u\s*\d+\s*:\s*([\s\S]*)$/);
  if (!m) return text;
  return m[1].trimStart();
}

/* ---------- b·ªô ƒë·ªÅ ---------- */
function getSavedSets() {
  try {
    const raw = localStorage.getItem(LS_KEY_SETS);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch { return []; }
}
function saveSetsToLS(sets) {
  try { localStorage.setItem(LS_KEY_SETS, JSON.stringify(sets)); }
  catch {}
}
function refreshSavedSetsUI() {
  const select = document.getElementById("savedSetsSelect");
  const sets = getSavedSets();
  select.innerHTML = "";
  if (!sets.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Ch∆∞a c√≥ b·ªô ƒë·ªÅ n√†o ƒë∆∞·ª£c l∆∞u";
    select.appendChild(opt);
    select.disabled = true;
    return;
  }
  select.disabled = false;
  sets.forEach((set, idx) => {
    const opt = document.createElement("option");
    opt.value = idx;
    opt.textContent = set.name;
    select.appendChild(opt);
  });
}

function saveCurrentSet() {
  const name = document.getElementById("setName").value.trim();
  const raw  = document.getElementById("rawQuestions").value.trim();
  const keyInput = document.getElementById("answerKey").value
                    .trim().toUpperCase().replace(/\s+/g,"");
  if (!name)    return alert("B·∫°n ch∆∞a nh·∫≠p t√™n b·ªô ƒë·ªÅ.");
  if (!raw)     return alert("B·∫°n ch∆∞a d√°n ƒë·ªÅ v√†o.");
  if (!keyInput)return alert("B·∫°n ch∆∞a nh·∫≠p chu·ªói ƒë√°p √°n.");

  const sets = getSavedSets();
  const idx  = sets.findIndex(s => s.name === name);
  const data = { name, rawQuestions: raw, answerKey: keyInput };

  if (idx >= 0) {
    if (!confirm("ƒê√£ c√≥ b·ªô ƒë·ªÅ tr√πng t√™n. Ghi ƒë√®?")) return;
    sets[idx] = data;
  } else sets.push(data);

  saveSetsToLS(sets);
  refreshSavedSetsUI();
  alert('ƒê√£ l∆∞u b·ªô ƒë·ªÅ "'+name+'".');
}

function loadSelectedSet() {
  const select = document.getElementById("savedSetsSelect");
  const idx = parseInt(select.value,10);
  const sets = getSavedSets();
  if (isNaN(idx) || !sets[idx]) return alert("Kh√¥ng c√≥ b·ªô ƒë·ªÅ h·ª£p l·ªá ƒë·ªÉ t·∫£i.");
  const set = sets[idx];
  document.getElementById("setName").value      = set.name;
  document.getElementById("rawQuestions").value = set.rawQuestions;
  document.getElementById("answerKey").value    = set.answerKey;
  alert("ƒê√£ t·∫£i b·ªô ƒë·ªÅ: "+set.name);
}

function deleteSelectedSet() {
  const select = document.getElementById("savedSetsSelect");
  const idx = parseInt(select.value,10);
  const sets = getSavedSets();
  if (isNaN(idx) || !sets[idx]) return alert("Kh√¥ng c√≥ b·ªô ƒë·ªÅ h·ª£p l·ªá ƒë·ªÉ xo√°.");
  if (!confirm('Xo√° b·ªô ƒë·ªÅ "'+sets[idx].name+'"?')) return;
  sets.splice(idx,1);
  saveSetsToLS(sets);
  refreshSavedSetsUI();
  alert("ƒê√£ xo√° b·ªô ƒë·ªÅ.");
}

/* --- export / import b·ªô ƒë·ªÅ --- */
function exportSets() {
  const sets = getSavedSets();
  if (!sets.length) return alert("Ch∆∞a c√≥ b·ªô ƒë·ªÅ n√†o ƒë·ªÉ xu·∫•t.");
  const blob = new Blob([JSON.stringify(sets,null,2)],{type:"application/json"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href = url;
  a.download = "quiz_sets_"+new Date().toISOString().split("T")[0]+".json";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function triggerImportSets() {
  document.getElementById("setsFileInput").click();
}
function importSetsFromFile(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) return alert("File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (ph·∫£i l√† m·∫£ng JSON).");
      let cur = getSavedSets();
      data.forEach(ns => {
        if (!ns || typeof ns!=="object") return;
        if (!ns.name || !ns.rawQuestions || !ns.answerKey) return;
        const i = cur.findIndex(s=>s.name===ns.name);
        if (i>=0) cur[i]=ns; else cur.push(ns);
      });
      saveSetsToLS(cur);
      refreshSavedSetsUI();
      alert("ƒê√£ import b·ªô ƒë·ªÅ. T·ªïng s·ªë b·ªô ƒë·ªÅ: "+cur.length);
    } catch {
      alert("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file JSON b·ªô ƒë·ªÅ.");
    } finally { ev.target.value=""; }
  };
  reader.readAsText(file);
}

/* ---------- l∆∞u / kh√¥i ph·ª•c tr·∫°ng th√°i quiz ---------- */
function saveCurrentState() {
  if (!questions.length) { localStorage.removeItem(LS_KEY_STATE); return; }
  const state = {
    rawQuestions: document.getElementById("rawQuestions").value.trim(),
    answerKey: document.getElementById("answerKey").value.trim().toUpperCase().replace(/\s+/g,""),
    setName: document.getElementById("setName").value.trim(),
    questions,
    shuffleEnabled,
    round,
    current,
    roundList,
    wrongList,
    finished
  };
  try { localStorage.setItem(LS_KEY_STATE, JSON.stringify(state)); } catch {}
}

function tryRestoreQuizState() {
  try {
    const raw = localStorage.getItem(LS_KEY_STATE);
    if (!raw) return;
    const state = JSON.parse(raw);
    if (!state || !Array.isArray(state.questions) || !state.questions.length) return;

    const label = state.setName ? '"'+state.setName+'"' : "(ch∆∞a ƒë·∫∑t t√™n)";
    if (!confirm(`Ph√°t hi·ªán b·∫°n c√≥ b√†i ƒëang l√†m d·ªü cho b·ªô ƒë·ªÅ ${label}.\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c kh√¥ng?`)) return;

    if (state.rawQuestions) document.getElementById("rawQuestions").value = state.rawQuestions;
    if (state.answerKey)    document.getElementById("answerKey").value    = state.answerKey;
    if (state.setName)      document.getElementById("setName").value      = state.setName;

    questions       = state.questions;
    shuffleEnabled  = !!state.shuffleEnabled;
    round           = state.round   || 1;
    current         = state.current || 0;
    roundList       = Array.isArray(state.roundList) && state.roundList.length
                      ? state.roundList : questions.map((_,i)=>i);
    wrongList       = Array.isArray(state.wrongList) ? state.wrongList : [];
    finished        = !!state.finished;

    document.getElementById("quiz-box").style.display = "block";
    renderQuestion();
  } catch {}
}

/* ---------- parse ƒë·ªÅ ---------- */
function parseQuestions(raw) {
  const blocks = raw
    .split(/(?=C√¢u\s*\d+\s*:)/g)
    .map(b=>b.trim())
    .filter(b=>b.length>0);

  const parsed = [];

  blocks.forEach(origBlock => {
    if (!origBlock) return;
    let block = origBlock.trim();

    // ∆Øu ti√™n th·∫ª <img> to√†n block
    let imageUrl = null;
    const imgTagMatch = block.match(/<img\b[^>]*src=["']([^"']+)["'][^>]*>/i);
    if (imgTagMatch) {
      imageUrl = imgTagMatch[1].trim();
      block = block.replace(imgTagMatch[0], "").trim();
    }

    const qMatch = block.match(/^C√¢u\s*\d+\s*:.*$/m);
    if (!qMatch) return;

    const headerLine = qMatch[0];
    const afterHeader = block.slice(qMatch.index + headerLine.length);

    const lines = afterHeader.split(/\r?\n/);
    let extraLines = [];
    let offsetInAfter = 0;

    for (let i = 0; i < lines.length; i++) {
      const ln = lines[i];
      const trimmed = ln.trim();
      if (trimmed.match(/^(?:[ABCD]\.|IMG\s*:|<img\b)/i)) break;
      extraLines.push(ln);
      offsetInAfter += ln.length + 1;
    }

    let questionText = headerLine;
    if (extraLines.length) questionText += "\n" + extraLines.join("\n");
    questionText = normalizeSpaces(questionText.trim());

    let after = afterHeader.slice(offsetInAfter).trim();

    // IMG: n·∫øu ch∆∞a c√≥ h√¨nh
    if (!imageUrl) {
      const imgLineMatch = after.match(/^IMG\s*:\s*(.+)$/m);
      if (imgLineMatch) {
        let imgLine = imgLineMatch[1].trim();
        const tagMatch2 = imgLine.match(/<img\b[^>]*src=["']([^"']+)["'][^>]*>/i);
        imageUrl = tagMatch2 ? tagMatch2[1].trim() : imgLine;
        after = after.replace(imgLineMatch[0], "").trim();
      }
    }

    const choicesObj = { A:"", B:"", C:"", D:"" };
    const re = /([ABCD])\.(.*?)(?=(?:[ABCD]\.|$))/gs;
    let m;
    while ((m = re.exec(after)) !== null) {
      const letter = m[1];
      const text = m[2]
        .replace(/\r?\n/g, " ")
        .replace(/\t/g, " ")
        .trimEnd();
      choicesObj[letter] = text;
    }

    const choiceArrRaw = ["A","B","C","D"].map(ch => (choicesObj[ch]||"").trim());
    if (!questionText || choiceArrRaw.some(c=>!c)) return;

    const choiceArr = choiceArrRaw.map(c => normalizeSpaces(c));

    parsed.push({
      text: questionText,
      choices: choiceArr,
      image: imageUrl || null
    });
  });

  return parsed;
}

/* ---------- t·∫°o ƒë·ªÅ 1 b·ªô ---------- */
function createQuiz() {
  const raw = document.getElementById("rawQuestions").value.trim();
  const key = document.getElementById("answerKey").value
                .trim().toUpperCase().replace(/\s+/g,"");
  if (!raw) return alert("B·∫°n ch∆∞a d√°n ƒë·ªÅ.");
  if (!key) return alert("B·∫°n ch∆∞a nh·∫≠p chu·ªói ƒë√°p √°n.");

  const parsed = parseQuestions(raw);
  if (!parsed.length)
    return alert("Kh√¥ng parse ƒë∆∞·ª£c c√¢u h·ªèi n√†o. Ki·ªÉm tra l·∫°i format 'C√¢u xx:' v√† A./B./C./D.");

  if (key.length !== parsed.length)
    return alert("S·ªë k√Ω t·ª± trong ƒë√°p √°n ("+key.length+") kh√°c s·ªë c√¢u h·ªèi ("+parsed.length+").");

  shuffleEnabled = confirm("B·∫°n c√≥ mu·ªën x√°o tr·ªôn th·ª© t·ª± c√¢u h·ªèi kh√¥ng?\nOK = C√≥, Cancel = Kh√¥ng.");

  const map = {A:0,B:1,C:2,D:3};
  const tmp = [];
  for (let i=0;i<parsed.length;i++) {
    const k   = key[i];
    const idx = map[k];
    if (idx===undefined)
      return alert("K√Ω t·ª± ƒë√°p √°n kh√¥ng h·ª£p l·ªá t·∫°i v·ªã tr√≠ "+(i+1)+": "+k+" (ch·ªâ A/B/C/D).");
    tmp.push({
      text: parsed[i].text,
      choices: parsed[i].choices,
      correctIndex: idx,
      image: parsed[i].image || null
    });
  }
  questions = tmp;
  startQuiz();
}

/* ---------- t·∫°o ƒë·ªÅ t·ª´ nhi·ªÅu b·ªô ƒë√£ l∆∞u ---------- */
function openMultiSetModal() {
  const overlay = document.getElementById("multiSetModalOverlay");
  const listDiv = document.getElementById("multiSetList");
  const sets = getSavedSets();
  listDiv.innerHTML = "";
  if (!sets.length) {
    const p = document.createElement("p");
    p.textContent = "Ch∆∞a c√≥ b·ªô ƒë·ªÅ n√†o ƒë∆∞·ª£c l∆∞u. H√£y l∆∞u √≠t nh·∫•t 1 b·ªô ƒë·ªÅ tr∆∞·ªõc.";
    p.style.fontSize = "14px";
    listDiv.appendChild(p);
  } else {
    sets.forEach((set, idx) => {
      const row = document.createElement("div");
      row.className = "multi-set-item";
      const cb  = document.createElement("input");
      cb.type = "checkbox";
      cb.id = "ms_"+idx;
      cb.value = idx;
      const label = document.createElement("label");
      label.setAttribute("for", "ms_"+idx);
      label.textContent = set.name || ("ƒê·ªÅ "+(idx+1));
      row.appendChild(cb);
      row.appendChild(label);
      listDiv.appendChild(row);
    });
  }
  overlay.style.display = "flex";
}

function closeMultiSetModal() {
  document.getElementById("multiSetModalOverlay").style.display = "none";
}

function createCombinedQuizFromSelected() {
  const sets = getSavedSets();
  if (!sets.length) {
    alert("Ch∆∞a c√≥ b·ªô ƒë·ªÅ n√†o ƒë·ªÉ g·ªôp.");
    return;
  }
  const listDiv = document.getElementById("multiSetList");
  const checkboxes = listDiv.querySelectorAll("input[type=checkbox]");
  const idxs = [];
  checkboxes.forEach(cb => {
    if (cb.checked) idxs.push(parseInt(cb.value, 10));
  });
  if (!idxs.length) {
    alert("B·∫°n ch∆∞a ch·ªçn ƒë·ªÅ n√†o ƒë·ªÉ g·ªôp.");
    return;
  }

  const removePrefix = confirm("B·∫°n c√≥ mu·ªën xo√° 'C√¢u xx:' kh·ªèi n·ªôi dung c√¢u h·ªèi khi g·ªôp ƒë·ªÅ kh√¥ng?\nOK = C√≥, Cancel = Kh√¥ng.");

  let combinedQuestions = [];
  let combinedRaw = "";
  let combinedKey = "";
  const map = {A:0,B:1,C:2,D:3};

  for (const idx of idxs) {
    const set = sets[idx];
    if (!set || !set.rawQuestions || !set.answerKey) {
      alert("M·ªôt trong c√°c ƒë·ªÅ ƒë∆∞·ª£c ch·ªçn kh√¥ng h·ª£p l·ªá, d·ª´ng thao t√°c.");
      return;
    }
    const parsed = parseQuestions(set.rawQuestions);
    const key = (set.answerKey || "").toUpperCase().replace(/\s+/g,"");
    if (parsed.length !== key.length) {
      alert(`ƒê·ªÅ "${set.name}" c√≥ s·ªë c√¢u (${parsed.length}) kh√°c s·ªë k√Ω t·ª± ƒë√°p √°n (${key.length}). Vui l√≤ng ki·ªÉm tra l·∫°i.`);
      return;
    }

    for (let i=0;i<parsed.length;i++) {
      const k = key[i];
      const ansIdx = map[k];
      if (ansIdx === undefined) {
        alert(`ƒê·ªÅ "${set.name}" c√≥ ƒë√°p √°n kh√¥ng h·ª£p l·ªá t·∫°i v·ªã tr√≠ ${i+1}: ${k}.`);
        return;
      }
      let txt = parsed[i].text;
      if (removePrefix) txt = stripCauPrefix(txt);
      combinedQuestions.push({
        text: txt,
        choices: parsed[i].choices,
        correctIndex: ansIdx,
        image: parsed[i].image || null
      });
    }

    combinedRaw += set.rawQuestions.trim() + "\n\n";
    combinedKey += key;
  }

  if (!combinedQuestions.length) {
    alert("Kh√¥ng t·∫°o ƒë∆∞·ª£c c√¢u h·ªèi n√†o sau khi g·ªôp.");
    return;
  }

  // H·ªèi x√°o tr·ªôn cho ƒë·ªÅ t·ªïng h·ª£p
  shuffleEnabled = confirm("B·∫°n c√≥ mu·ªën x√°o tr·ªôn th·ª© t·ª± c√¢u h·ªèi cho ƒë·ªÅ t·ªïng h·ª£p kh√¥ng?\nOK = C√≥, Cancel = Kh√¥ng.");

  questions = combinedQuestions;

  // G√°n v√†o √¥ raw/answer ƒë·ªÉ c√≥ th·ªÉ l∆∞u l·∫°i n·∫øu mu·ªën
  document.getElementById("rawQuestions").value = combinedRaw.trim();
  document.getElementById("answerKey").value = combinedKey;
  const selectedNames = idxs.map(i => sets[i].name || ("ƒê·ªÅ "+(i+1)));
  document.getElementById("setName").value = "T·ªïng h·ª£p: " + selectedNames.join(" + ");

  closeMultiSetModal();
  startQuiz();
}

/* ---------- logic quiz ---------- */
function startQuiz() {
  if (!questions.length) return alert("Ch∆∞a c√≥ c√¢u h·ªèi.");
  let indices = questions.map((_,i)=>i);
  if (shuffleEnabled) indices = shuffleArray(indices);

  roundList = indices;
  wrongList = [];
  round     = 1;
  current   = 0;
  finished  = false;
  waitingToContinue = false;
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("submitBtn").style.display = "inline-block";

  document.getElementById("quiz-box").style.display = "block";
  renderQuestion();
}

function clearChoiceStyles() {
  document.querySelectorAll(".choice-card").forEach(card => {
    card.classList.remove("correct","incorrect");
  });
}

function renderQuestion() {
  const qIndex = roundList[current];
  const q = questions[qIndex];

  document.getElementById("progress").innerText =
    `L∆∞·ª£t ${round} ‚Äì C√¢u ${current+1}/${roundList.length} (T·ªïng: ${questions.length} c√¢u)`;
  document.getElementById("quiz-title").innerText = q.text;
  document.getElementById("quiz-text").innerText  = "";

  const imgWrap = document.getElementById("quiz-image-wrapper");
  const imgEl   = document.getElementById("quiz-image");
  if (q.image) {
    imgEl.src = q.image;
    imgWrap.style.display = "block";
  } else {
    imgWrap.style.display = "none";
    imgEl.removeAttribute("src");
  }

  document.getElementById("c1").innerText = q.choices[0];
  document.getElementById("c2").innerText = q.choices[1];
  document.getElementById("c3").innerText = q.choices[2];
  document.getElementById("c4").innerText = q.choices[3];

  const st = document.getElementById("status");
  st.innerText = ""; st.className = "";

  selectedChoice = null;
  waitingToContinue = false;
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("submitBtn").style.display = "inline-block";
  clearChoiceStyles();
  updateChoiceSelection();
  saveCurrentState();
}

function updateChoiceSelection() {
  document.querySelectorAll(".choice-card").forEach(card=>{
    const idx = Number(card.getAttribute("data-index"));
    card.classList.toggle("selected", idx===selectedChoice);
  });
}

function attachChoiceEvents() {
  document.querySelectorAll(".choice-card").forEach(card=>{
    card.addEventListener("click", ()=>{
      if (waitingToContinue) return;
      selectedChoice = Number(card.getAttribute("data-index"));
      updateChoiceSelection();
    });
  });
}

/* ---- zoom ·∫£nh ---- */
function attachImageZoomEvents() {
  const quizImg   = document.getElementById("quiz-image");
  const overlay   = document.getElementById("image-modal-overlay");
  const modalImg  = document.getElementById("image-modal");

  quizImg.addEventListener("click", () => {
    if (!quizImg.src) return;
    modalImg.src = quizImg.src;
    overlay.style.display = "flex";
  });

  overlay.addEventListener("click", () => {
    overlay.style.display = "none";
    modalImg.removeAttribute("src");
  });
}

function submitAnswer() {
  if (finished) return;
  if (waitingToContinue) return;
  if (selectedChoice===null) return alert("H√£y ch·ªçn m·ªôt ƒë√°p √°n.");

  const qIndex = roundList[current];
  const q = questions[qIndex];
  const st = document.getElementById("status");
  const cards = document.querySelectorAll(".choice-card");

  clearChoiceStyles();

  if (selectedChoice === q.correctIndex) {
    st.innerText = "ƒê√∫ng r·ªìi! ‚úÖ";
    st.className = "ok";
    if (cards[selectedChoice]) {
      cards[selectedChoice].classList.add("correct");
    }
    saveCurrentState();
    setTimeout(nextQuestion, 900);
  } else {
    st.innerText = "Sai ‚Äì ƒë√°p √°n ƒë√∫ng ƒë√£ ƒë∆∞·ª£c t√¥ xanh. B·∫•m \"Ti·∫øp t·ª•c\" ƒë·ªÉ sang c√¢u k·∫ø.";
    st.className = "err";

    if (cards[selectedChoice]) {
      cards[selectedChoice].classList.add("incorrect");
    }
    if (cards[q.correctIndex]) {
      cards[q.correctIndex].classList.add("correct");
    }

    if (!wrongList.includes(qIndex)) wrongList.push(qIndex);

    waitingToContinue = true;
    document.getElementById("submitBtn").style.display = "none";
    document.getElementById("nextBtn").style.display = "inline-block";
    saveCurrentState();
  }
}

/* --- B·ªé QUA: xem ƒë√°p √°n ƒë√∫ng, KH√îNG t√≠nh sai, KH√îNG l·∫∑p l·∫°i ·ªü l∆∞·ª£t sau --- */
function skipQuestion() {
  if (finished) return;
  if (waitingToContinue) return;

  const qIndex = roundList[current];
  const q = questions[qIndex];
  const st = document.getElementById("status");
  const cards = document.querySelectorAll(".choice-card");

  clearChoiceStyles();
  selectedChoice = null;

  if (cards[q.correctIndex]) {
    cards[q.correctIndex].classList.add("correct");
  }

  st.innerText = "B·∫°n ƒë√£ ch·ªçn \"B·ªè qua\" ‚Äì ƒë√¢y l√† ƒë√°p √°n ƒë√∫ng. C√¢u n√†y s·∫Ω kh√¥ng t√≠nh l√† sai.";
  st.className = "ok";

  waitingToContinue = true;
  document.getElementById("submitBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "inline-block";
  saveCurrentState();
}

/* --- CH·ªäU: xem ƒë√°p √°n ƒë√∫ng, C√ì t√≠nh sai, l·∫∑p l·∫°i ·ªü l∆∞·ª£t sai --- */
function giveUpQuestion() {
  if (finished) return;
  if (waitingToContinue) return;

  const qIndex = roundList[current];
  const q = questions[qIndex];
  const st = document.getElementById("status");
  const cards = document.querySelectorAll(".choice-card");

  clearChoiceStyles();
  selectedChoice = null;

  if (cards[q.correctIndex]) {
    cards[q.correctIndex].classList.add("correct");
  }

  st.innerText = "B·∫°n ƒë√£ ch·ªçn \"Ch·ªãu\" ‚Äì c√¢u n√†y s·∫Ω ƒë∆∞·ª£c t√≠nh l√† sai. B·∫•m \"Ti·∫øp t·ª•c\" ƒë·ªÉ sang c√¢u k·∫ø.";
  st.className = "err";

  if (!wrongList.includes(qIndex)) wrongList.push(qIndex);

  waitingToContinue = true;
  document.getElementById("submitBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "inline-block";
  saveCurrentState();
}

function manualNext() {
  if (!waitingToContinue) return;
  waitingToContinue = false;
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("submitBtn").style.display = "inline-block";
  nextQuestion();
}

function nextQuestion() {
  if (finished) return;
  if (current < roundList.length - 1) {
    current++;
    renderQuestion();
  } else {
    const st = document.getElementById("status");
    if (wrongList.length) {
      round++;
      let next = [...wrongList];
      wrongList = [];
      if (shuffleEnabled) next = shuffleArray(next);
      roundList = next;
      current   = 0;
      st.innerText = `B·∫°n v·∫´n c√≤n c√¢u sai. Chuy·ªÉn sang l∆∞·ª£t ${round} ch·ªâ g·ªìm c√°c c√¢u sai.`;
      st.className = "err";
      renderQuestion();
    } else {
      finished = true;
      st.innerText = "üéâ Ho√†n th√†nh! T·∫•t c·∫£ c√¢u h·ªèi ƒë·ªÅu ƒë√∫ng ho·∫∑c ƒë√£ ƒë∆∞·ª£c b·∫°n b·ªè qua.";
      st.className = "ok";
      saveCurrentState();
    }
  }
}

function restartQuiz() {
  if (!questions.length) return;
  let indices = questions.map((_,i)=>i);
  if (shuffleEnabled) indices = shuffleArray(indices);
  roundList = indices;
  wrongList = [];
  round = 1;
  current = 0;
  finished = false;
  waitingToContinue = false;
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("submitBtn").style.display = "inline-block";
  renderQuestion();
}

/* X√°c nh·∫≠n tr∆∞·ªõc khi reset */
function confirmReset() {
  if (!questions.length) return;
  const ok = confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën Reset l∆∞·ª£t l√†m b√†i n√†y kh√¥ng?\nT·∫•t c·∫£ ti·∫øn tr√¨nh (l∆∞·ª£t, c√¢u sai, tr·∫°ng th√°i) s·∫Ω b·∫Øt ƒë·∫ßu l·∫°i t·ª´ ƒë·∫ßu.");
  if (ok) restartQuiz();
}

/* ----- Ch·∫ø ƒë·ªô giao di·ªán ƒëi·ªán tho·∫°i ----- */
function toggleMobileMode() {
  const body = document.body;
  const enabled = body.classList.toggle("mobile-mode");
  const label = document.getElementById("mobileModeLabel");
  if (label) label.textContent = enabled ? "B·∫≠t" : "T·∫Øt";
  try { localStorage.setItem(LS_KEY_MOBILE, enabled ? "1" : "0"); } catch {}
}

/* ----- Chuy·ªÉn ƒë·ªïi giao di·ªán s√°ng / t·ªëi ----- */
function toggleTheme() {
  const body = document.body;
  const isLight = body.classList.toggle("light-theme");
  const label = document.getElementById("themeLabel");
  if (label) label.textContent = isLight ? "S√°ng" : "T·ªëi";
  try { localStorage.setItem(LS_KEY_THEME, isLight ? "light" : "dark"); } catch {}
}

/* ----- Thay ƒë·ªïi k√≠ch c·ª° trang ----- */
function applyScale(scale) {
  const body = document.body;
  body.classList.remove("scale-small","scale-medium","scale-large");
  if (scale === "small")  body.classList.add("scale-small");
  if (scale === "medium") body.classList.add("scale-medium");
  if (scale === "large")  body.classList.add("scale-large");
  const select = document.getElementById("scaleSelect");
  if (select) select.value = scale;
}
function changeScale() {
  const select = document.getElementById("scaleSelect");
  const val = select.value || "medium";
  applyScale(val);
  try { localStorage.setItem(LS_KEY_SCALE, val); } catch {}
}

/* ---------- init ---------- */
function init() {
  attachChoiceEvents();
  attachImageZoomEvents();
  refreshSavedSetsUI();
  tryRestoreQuizState();

  // kh√¥i ph·ª•c mobile-mode
  try {
    const mm = localStorage.getItem(LS_KEY_MOBILE);
    if (mm === "1") {
      document.body.classList.add("mobile-mode");
      const label = document.getElementById("mobileModeLabel");
      if (label) label.textContent = "B·∫≠t";
    }
  } catch {}

  // kh√¥i ph·ª•c theme
  try {
    const theme = localStorage.getItem(LS_KEY_THEME);
    const label = document.getElementById("themeLabel");
    if (theme === "light") {
      document.body.classList.add("light-theme");
      if (label) label.textContent = "S√°ng";
    } else {
      if (label) label.textContent = "T·ªëi";
    }
  } catch {}

  // kh√¥i ph·ª•c scale
  try {
    const savedScale = localStorage.getItem(LS_KEY_SCALE) || "medium";
    applyScale(savedScale);
  } catch {
    applyScale("medium");
  }
}
document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
